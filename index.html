<!doctype html>
<html lang="">
    <head>
        <meta charset="utf-8">
        <title>Emcien Rules</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://fonts.googleapis.com/css?family=Raleway:200,300,400,500,700" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="css/page.css">
        <script src="https://fastcdn.org/Underscore.js/1.8.3/underscore-min.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script src="js/rule_tree.js"></script>
  </head>
  <body>
    <header>
      <div>
        <img src="images/emcien-logo.png" width="131" height="32" alt="Emcien">

        <div class="inputs">
          <input type="text" name="server" id="server" placeholder="Server">
          <input type="password" name="token" id="token" placeholder="Auth Token">
          <input type="text" name="report" id="report" placeholder="Report ID">
          <span class="submit"><i class="fa-arrow-circle-right fa"></i></span>
          <select class="outcome-selector" name="outcome"><option disabled="disabled" selected>Load a Report</option></select>
        </div>
      </div>
    </header>

    <div class="stage">
      <span class="rule-show">Welcome to <em>Emcien Rules Explorer</em></span>
    </div>

    <div class="actors">
      <h2>Select Categorys & Items to Explore</h2>
      <div class="actors-slot">
        <table>
          <thead>
            <tr>
              <th class="level-1"></th>
              <th class="level-2"></th>
              <th class="level-3"></th>
              <th class="level-4"></th>
              <th class="level-5"></th>
            </tr>
          <tbody>
            <tr>
              <td class="level-1" data-level="1"></td>
              <td class="level-2" data-level="2"></td>
              <td class="level-3" data-level="3"></td>
              <td class="level-4" data-level="4"></td>
              <td class="level-5" data-level="5"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <script>
      var callback = function() {
        // erase all content after "depth"
        var _this = this;
        var _depth = this.depth;

        if(_.keys(_this.categories).length > 0){
          $("th.level-" + _depth).text("Level " + _depth);
        }else{
          $("th.level-" + _depth).text("");
        }

        for (var i = _depth + 1; i <= 5; i ++) {
          $("td.level-" + i).html("");
        }

        $("td.level-" + _depth).html("<ul class='parent'>");

        var cat_pills = [];

        // this will use the catOrder ordering, but only include keys from the categories list
        var cats = _.intersection(this.catOrder, _.keys(this.categories));

        var _dots = function(this_impact, max_impact){
          var categoryOutcomeImpactPct = (this_impact / max_impact) * 100;

          var _els = [];
          var fullCircles = Math.floor(categoryOutcomeImpactPct / 20);
          for (var x = 0; x < fullCircles; x++) {
            _els.push('<i class="fa fa-circle" aria-hidden="true"></i>')
          }

          var halfCircle = (categoryOutcomeImpactPct % 20) >= 10;
          if (halfCircle) {
            _els.push('<i class="fa fa-adjust aria-hidden="true"></i>')
          }

          var emptyCircles = 5 - fullCircles - halfCircle;
          for (var y = 0; y < emptyCircles; y++) {
            _els.push('<i class="fa fa-circle-o" aria-hidden="true"></i>')
          }

          return _els.reverse().join('');
        }

        for (var i = 0; i < cats.length; i ++) {
          var max_impact = this.catImpacts[cats[0]];
          var this_impact = this.catImpacts[cats[i]];

          cat_pills.push("<span class=\"dots\" title=\"Category Impact: " + this_impact + "\">" + _dots(this_impact, max_impact) + "</span><span class=\"category-pill\" data-impact=" + this_impact + ">" + cats[i] + "</span>");
        }

        for (var i = 0; i < cats.length; i ++) {
          var items = this.categories[cats[i]];
          items = _.sortBy(items, "cprob").reverse();

          var _lift = function(lift){
            var result = "";
            if(lift == 0){
              result = "<span class=\"very-unlikely\">Very Unlikely</span>"
            }else if(lift > 2){
              result = "<i class=\"fa fa-arrow-circle-up arrow-up\"></i> " + Math.round(lift, -1) + "<small>X</small> more likely"
            }else if(lift > 1){
              result = "<i class=\"fa fa-arrow-circle-up arrow-up\"></i> " + Math.round(lift * 100) + "<small>%</small> more likely"
            }else if(lift < 0.5){
              result = "<i class=\"fa fa-arrow-circle-down arrow-down\"></i> " + Math.round(lift, -1) + "<small>X</small> less likely"
            }else if(lift < 1){
              result = "<i class=\"fa fa-arrow-circle-down arrow-down\"></i> " + Math.round(lift * 100) + "<small>%</small> less likely"
            }else{
              result = "--"
            }
            return "<span class=\"lift\">" + result + "</span>";
          }

          var itemList = "<ul class='child' style='display: none;'>"
          for (var j = 0; j < items.length; j ++) {
            var item = items[j];
            itemList += "<li class='item' data-freq='" + item.freq + "' data-cprob='" + item.cprob + "' data-outcome='" + item.outcome + "' data-lift='" + item.lift + "' data-id='" + item.id + "' data-name='" + item.name + "' data-cat='" + cats[i] + "'><span class=\"item-pill\">" + item.name + "</span>" + _lift(item.lift) + "</li>";
          }
          itemList += "</ul>"

          $("ul.parent", "td.level-" + _depth).append("<li class='cat'>" + cat_pills[i] + itemList + "</li>");
        }

        $("td.level-" + _depth).append("</ul>");

        $("li.cat", "td.level-" + _depth + " ul.parent").on("click", function() {
          $("ul.child", "td.level-" + _depth).hide().parent("li");
          $("td.level-" + _depth).find(".active").removeClass("active");

          var children = $("li.item", this).first().attr('data-children');
          if (typeof children !== typeof undefined && children !== false) {
            $("ul.child", this).fadeIn();
          } else {
            // rule count prefetch!
            var itemIds = _.map($("li.item", this), function(d) { return $(d).data("id").toString(); });
            ruleTree.prefetchList = itemIds;

            var level = $(this).parent().parent().data("level");
            ruleTree.fetchCounts.call(this, categoryCallback, level, this);
          }
        });

        $("li.item", "td.level-" + _depth).on("click", function() {
          $("li.item", "td.level-" + _depth).removeClass("active-item");
          $("li.cat", "td.level-" + _depth).removeClass("active");
          $(this).addClass("active-item");

          var id = $(this).data().id.toString();
          var cat = $(this).data().cat;
          var lift = $(this).data().lift;
          var item_name = $(this).data().name;
          var outcome = $(this).data().outcome;
          var freq = $(this).data().freq;
          var cprob = Math.round((100 * $(this).data().cprob), -1);

          _this.rule.length = _depth - 1;
          _this.ruleString.length = _depth - 1;
          _this.rule[_depth - 1] = id;
          _this.ruleString[_depth - 1] = "<span class=\"item-pill with-cat\">" + item_name + "<small>" + cat + "</small></span>";

          $(".rule-show").html("Transaction containing " + _this.ruleString.join(" and ") + " are " + _lift(lift) + " to contain <span class=\"outcome-text\">" + outcome + "</span><div class=\"sub-text\">" + freq + " Occurrences in Training Data. " + cprob + "% Conditional Probability.<div>");

          _this.dig(_depth + 1);
        });
      };

      var outcomeCallback = function() {
        // we want to re-hide it if we're submitting a different report
        $(".outcome").hide();

        // add the placeholder
        $("select.outcome-selector").html("<option value='' disabled selected>Select an outcome</option>");

        // fill in all the options that have been populated
        for (var i = 0; i < ruleTree.outcomes.length; i ++) {
          var outcome = ruleTree.outcomes[i];
          var name = outcome.category + "::" + outcome.name;
          $("select.outcome-selector").append("<option value=" + outcome.id + ">" + name + "</option>");
        }

        $(".outcome").fadeIn();
      };

      var categoryCallback = function() {
        $("li.item", this).each(function() {
          var childCount = ruleTree.prefetchCounts[$(this).data("id")];
          $(this).attr("data-children", childCount);
          if(childCount > 0){
            $(".item-pill", this).addClass("has_children");
          }else{
            $(".item-pill", this).addClass("no_children");
          }
        });

        $("ul.child", this).fadeIn();
      };

      $(document).ready(function() {
        // retrieve input values from local storage
        $("input").each(function() {
          this.value = localStorage.getItem(this.name);
        });

        var opts = {};
        $(".submit").on("click", function() {
          $("input").each(function() {
            localStorage.setItem(this.name, this.value);
            opts[this.name] = this.value;
          });

          $(".actors").fadeIn();

          window.ruleTree = new RuleTree(opts.server, opts.token, opts.report, callback);

          // fetch the outcomes and populate the option dropdown with the outcomes
          ruleTree.fetchOutcomes(outcomeCallback);
        });

        // changing an outcome resets the rule
        $("select.outcome-selector").change(function() {
          ruleTree.outcome = this.value;
          ruleTree.rule = [];

          ruleTree.fetchCategories(function() {
            ruleTree.dig();
          });
        });
      });
    </script>
  </body>
</html>
