<!doctype html>
<html lang="">
    <head>
        <meta charset="utf-8">
        <title>Emcien Rules Explorer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://fonts.googleapis.com/css?family=Raleway:200,300,400,500,700" rel="stylesheet">
        <link rel="stylesheet" href="css/page.css">
        <script src="https://fastcdn.org/Underscore.js/1.8.3/underscore-min.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script src="js/rule_tree.js"></script>
  </head>
  <body>
    <header>
      <div><img src="images/emcien-logo.png" width="131" height="32" alt="Emcien"></div>
    </header>

    <div class="inputs">
      <label for="server">Server</label>
      <input type="text" name="server" id="server">
      <label for="token">Auth Token</label>
      <input type="text" name="token" id="token">
      <label for="report">Report</label>
      <input type="text" name="report" id="report">
      <span class="submit">GO</span>
    </div>

    <div class="outcome" style="display:none;">
      <label for="outcome">Outcome</label>
      <select class="outcome-selector" name="outcome"></select>
    </div>

    <div class="stage">
      <span class="rule-show">Please select a category and item</span>
    </div>

    <div class="actors">
      <table>
        <thead>
          <tr>
            <th class="level-1">Level 1</th>
            <th class="level-2"></th>
            <th class="level-3"></th>
            <th class="level-4"></th>
            <th class="level-5"></th>
          </tr>
        <tbody>
          <tr>
            <td class="level-1"></td>
            <td class="level-2"></td>
            <td class="level-3"></td>
            <td class="level-4"></td>
            <td class="level-5"></td>
          </tr>
        </tbody>
      </table>
    </div>


    <script>
      var callback = function() {
        // erase all content after "depth"
        var _this = this;
        var _depth = this.depth;

        $("th.level-" + _depth).text("Level " + _depth);

        for (var i = _depth + 1; i <= 5; i ++) {
          $("td.level-" + i).html("");
        }

        $("td.level-" + _depth).html("<ul class='parent'>");

        var cat_pills = [];

        // this will use the catOrder ordering, but only include keys from the categories list
        var cats = _.intersection(this.catOrder, _.keys(this.categories));

        for (var i = 0; i < cats.length; i ++) {
          cat_pills.push("<span class=\"category-pill\">" + cats[i] + "</span>");
        }

        if(cat_pills.length < 1){
          $("ul.parent", "td.level-" + _depth).append("<li class=\"none\">No Rules Matched</li>");
        }

        for (var i = 0; i < cats.length; i ++) {
          var items = this.categories[cats[i]];
          items = _.sortBy(items, "cprob").reverse();

          var itemList = "<ul class='child' style='display: none;'>"
          for (var j = 0; j < items.length; j ++) {
            var item = items[j];
            var pretty_prob = Math.round(item.cprob * 100, -2) + "%";
            itemList += "<li class='item' data-cprob='" + item.cprob + "' data-outcome='" + item.outcome_name + "' data-id='" + item.id + "' data-cat='" + cats[i] + "'><span class=\"spark-bar\"><span class=\"spark-bar-fill\" style=\"width:" + (item.cprob * 30) + "px\"></span></span><span class=\"item-pill\">" + item.name + "</span><span class=\"side-prob\">" + pretty_prob + "</span></li>";
          }
          itemList += "</ul>"

          $("ul.parent", "td.level-" + _depth).append("<li class='cat'>" + cat_pills[i] + itemList + "</li>");
        }

        $("td.level-" + _depth).append("</ul>");

        $("li.cat", "ul.parent").on("click", function() {
          $("ul.child", "td.level-" + _depth).hide().parent("li");

          $("td.level-" + _depth).find(".active").removeClass("active");

          $("ul.child", this).show();
        });

        $("li.item", "td.level-" + _depth).on("click", function() {
          $("li.item", "td.level-" + _depth).removeClass("active-item");
          $("li.cat", "td.level-" + _depth).removeClass("active");
          $(this).addClass("active-item");

          var id = $(this).data().id.toString();
          var cat = $(this).data().cat;
          var name = $(this).html();
          _this.rule.length = _depth - 1;
          _this.ruleString.length = _depth - 1;
          _this.rule[_depth - 1] = id;
          _this.ruleString[_depth - 1] = "<strong>" + cat + "::" + name + "</strong>";
          _this.outcome_name = "<span class=\"outcome\">" + $(this).data().outcome + "</span>";
          _this.cprob = Math.round(($(this).data().cprob * 100), -2) + "%"

          $(".rule-show").html("Transaction containing " + _this.ruleString.join(" and ") + " have a " + _this.cprob + " of containing " + _this.outcome_name);

          _this.dig(_depth + 1);
        });
      };

      var outcomeCallback = function() {
        // we want to re-hide it if we're submitting a different report
        $(".outcome").hide();

        // add the placeholder
        $("select.outcome-selector").html("<option value='' disabled selected hidden>Select an outcome</option>");

        // fill in all the options that have been populated
        for (var i = 0; i < ruleTree.outcomes.length; i ++) {
          var outcome = ruleTree.outcomes[i];
          var name = outcome.category + "::" + outcome.name;
          $("select.outcome-selector").append("<option value=" + outcome.id + ">" + name + "</option>");
        }

        $(".outcome").show();
      };


      $(document).ready(function() {
        // retrieve input values from local storage
        $("input").each(function() {
          this.value = localStorage.getItem(this.name);
        });

        var opts = {};
        $(".submit").on("click", function() {
          $("input").each(function() {
            localStorage.setItem(this.name, this.value);
            opts[this.name] = this.value;
          });

          window.ruleTree = new RuleTree(opts.server, opts.token, opts.report, callback);

          // fetch the outcomes and populate the option dropdown with the outcomes
          ruleTree.fetchOutcomes(outcomeCallback);
        });

        $("select.outcome-selector").change(function() {
          ruleTree.outcome = this.value;

          ruleTree.fetchCategories(function() {
            ruleTree.dig();
          });
        });
      });
    </script>
  </body>
</html>
